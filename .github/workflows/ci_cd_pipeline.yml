name: MLOps CI/CD Pipeline

# Trigger the workflow on pushes to the 'main' branch
on:
  push:
    branches: [ main ] 
  pull_request:
    branches: [ main ]

# Define environment variables for Docker deployment
# NOTE: Replace 'your-dockerhub-username' with your actual username, 
# or ensure DOCKER_USERNAME is set as a repository secret.
env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/simple-ml-model 
  IMAGE_TAG: ${{ github.sha }} # Use the unique commit hash as the image tag

jobs:
  # -----------------------------------------------------
  # CI JOB: Test Code and Create Model Artifact
  # -----------------------------------------------------
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîç Checkout Repository
      uses: actions/checkout@v4

    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: üì¶ Install Dependencies
      run: pip install -r requirements.txt

    - name: ‚úÖ Run Unit Tests
      # Assuming 'pytest' is in requirements.txt and tests are in the 'tests/' folder
      run: pytest tests/

    - name: üß† Train and Save Model
      # Runs the ML training script
      run: python train.py
      
    - name: ‚¨ÜÔ∏è Upload Trained Model Artifact
      # Stores the model for the next job (CD)
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: model.pkl # The file generated by train.py

  # -----------------------------------------------------
  # CD JOB: Package Model and Deploy (Runs only if CI passes)
  # -----------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test # This job requires the CI job to succeed
    if: github.ref == 'refs/heads/main' # Only deploy if pushing to the main branch

    steps:
      - name: üîç Checkout Repository
        uses: actions/checkout@v4

      - name: ‚¨áÔ∏è Download Model Artifact
        # Retrieves the model.pkl created and stored by the 'build-and-test' job
        uses: actions/download-artifact@v4
        with:
          name: trained-model 
          path: . 

      - name: üîë Log in to Docker Hub
        # Uses your GitHub Secrets for secure authentication
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: üèóÔ∏è Build and Push Docker Image
        # Packages the app.py, Dockerfile, and the downloaded model.pkl
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} # Unique tag
            ${{ env.DOCKER_IMAGE }}:latest # Latest tag
          file: ./Dockerfile

      - name: üöÄ Deployment Placeholder
        run: |
          echo "Image ${{ env.DOCKER_IMAGE }}:${{ env.IMAGE_TAG }} built and pushed to Docker Hub."
          echo "--- ADD ACTUAL DEPLOYMENT COMMANDS HERE ---"
          # Example: Deploying to a Kubernetes cluster or a cloud service (AWS, Azure, GCP)
